<!DOCTYPE html>
<html lang="en">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-array.v2.min.js"></script>
  <style>
    circle {
      fill: lightblue;
      stroke: black;
    }
    h1,
    h2,
    h3 {
      text-align: center;
      color: #698db3;
    }
    #buttoncontainer {
      text-align: center;
    }
    #svgp {
      text-align: center;
    }
    p {
      color: #698db3;
      padding-left: 32%;
      padding-right: 32%;
    }
  </style>
  <body onload="init()">
    <h1>2020 Hawaii Paycheck Protection Program (PPP) Lenders Trend</h1>
    <h2>Scene 2: Top 5 Lender v.s. Approved Loan Amount Across Time</h2>

    <div id="svgp">
      <p>
        Within the top 20% Loan Amount bracket across time, most loan amount are
        approved by Central Pacific Bank, First Hawaiian Bank and American
        Savings. Most loan amount approved by Hawaiian National Bank are within
        the bottom 50% bracket across time.
      </p>
      <div id="scatters2"></div>
    </div>
    <div id="buttoncontainer">
      <form action="/index.html">
        <button type="submit">Go to Scene 1</button>
      </form>
      <form action="/scene3.html">
        <button type="submit">Go to Scene 3</button>
      </form>
    </div>
    <script>
      async function init() {
        const data = await d3.csv("./ppp_data.csv");

        // filter and select top N lenders
        // group and roll-up

        let LoanAmountByLenders = d3.rollup(
          data,
          (v) => d3.sum(v, (d) => d.LoanAmount),
          (d) => d.Lender
        );
        const topN = 5;
        let topNLoanAmountByLenders_array = Array.from(
          LoanAmountByLenders,
          ([name, value]) => ({ name, value })
        )
          .sort(function (x, y) {
            return d3.descending(x.value, y.value);
          })
          .slice(0, topN);

        let topNLenders = topNLoanAmountByLenders_array.map((a) => a.name);

        topNdata = data.filter((entry) => topNLenders.includes(entry.Lender));
        // console.log(topNLenders);
        // console.log(topNdata);

        var parseDate = d3.timeParse("%Y-%m-%dT%H:%M:%SZ");
        // console.log(data[0].DateApproved);
        topNdata.forEach(function (part, index) {
          topNdata[index].DateApproved = parseDate(part.DateApproved);
          topNdata[index].LoanAmount = parseFloat(part.LoanAmount);
        });

        topNdata.sort(function (a, b) {
          return a.DateApproved - b.DateApproved;
        });

        // console.log(data[0].DateApproved);
        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 250, bottom: 100, left: 150 },
          width = 900 - margin.left - margin.right,
          height = 850 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
          .select("#scatters2")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        // build and add x axis
        var x = d3
          .scaleTime()
          .domain(
            d3.extent(data, function (d) {
              return d.DateApproved;
            })
          )
          .range([0, width]);

        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");

        svg
          .append("text")
          .attr("fill", "black")

          .attr("transform", "translate(270, 800)")
          .style("text-anchor", "middle")
          .text("Date Approved");

        // build and add Y axis
        var y = d3
          .scaleLinear()
          .domain([
            0,
            d3.max(data, function (d) {
              return d.LoanAmount;
            }),
          ])
          .range([height, 0]);
        svg.append("g").call(d3.axisLeft(y));
        svg
          .append("text")
          .attr("fill", "black")
          .attr("transform", "translate(-150, 400)")
          .text("Loan Amount ($)");

        // color palette
        // var lender_list = data.map(function (d) {
        //   return d.Lender;
        // }); // list of group names
        // let unique_lenders = [...new Set(lender_list)];

        var color = d3.scaleOrdinal().domain(topNLenders).range(d3.schemeSet3);
        // console.log(data[0].LoanAmount);

        // Draw the dots
        svg
          .append("g")
          .selectAll("dot")
          .data(topNdata)
          .enter()
          .append("circle")
          .attr("cx", function (d) {
            // console.log(d.DateApproved);
            return x(d.DateApproved);
          })
          .attr("cy", function (d) {
            return y(d.LoanAmount);
          })
          .attr("r", 4)
          .style("fill", function (d) {
            return color(d.Lender);
          });

        // Legend:Add one dot in the legend for each name.
        svg
          .selectAll("mydots")
          .data(topNLenders)
          .enter()
          .append("circle")
          .attr("cx", 540)
          .attr("cy", function (d, i) {
            return 0 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .attr("r", 3)
          .style("fill", function (d) {
            return color(d);
          });

        // Legend: Add one text next to the dot in the legend for each name.
        svg
          .selectAll("mylabels")
          .data(topNLenders)
          .enter()
          .append("text")
          .attr("x", 550)
          .attr("y", function (d, i) {
            return 0 + i * 25;
          }) // 100 is where the first dot appears. 25 is the distance between dots
          .style("fill", function (d) {
            return color(d);
          })
          .text(function (d) {
            return d;
          })
          .attr("text-anchor", "left")
          .style("alignment-baseline", "middle");
        // svg
        //   .append("g")
        //   .attr("transform", "translate(60,10)")
        //   .selectAll("circle")
        //   .data(sumstat)
        //   .enter()
        //   .append("circle")
        //   .attr("cx", function (d) {
        //     return x(+d.DateApproved);
        //   })
        //   .attr("cy", function (d) {
        //     return y(d.LoanAmount);
        //   })
        //   .attr("r", 1)
        //   .style("fill", function (d) {
        //     return color(d.key);
        //   });
        // svg
        //   .selectAll(".line")
        //   .data(sumstat)
        //   .enter()
        //   .append("path")
        //   .attr("fill", "none")
        //   .attr("stroke", function (d) {
        //     return color(d.key);
        //   })
        //   .attr("stroke-width", 1.5)
        //   .attr("d", function (d) {
        //     return d3
        //       .line()
        //       .x(function (d) {
        //         return x(d.LoanAmount);
        //       })
        //       .y(function (d) {
        //         return y(+d.DateApproved);
        //       })(d.values);
        //   });
      }
    </script>
  </body>
</html>
